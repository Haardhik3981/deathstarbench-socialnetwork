apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: cse239fall2025
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      scrape_timeout: 10s
      evaluation_interval: 15s
      external_labels:
        cluster: 'social-network'
        environment: 'production'

    scrape_configs:

      # -------------------------------------------------------
      # 1) Prometheus itself
      # -------------------------------------------------------
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # -------------------------------------------------------
      # 2) Social Network Services - Scraping from Sidecar Exporters
      # Each service has a prometheus-exporter sidecar on port 9091
      # -------------------------------------------------------
      - job_name: 'socialnetwork-services'
        static_configs:
          - targets:
              # Core services (sidecar exporters on port 9091)
              - compose-post-service.cse239fall2025.svc.cluster.local:9091
              - home-timeline-service.cse239fall2025.svc.cluster.local:9091
              - user-timeline-service.cse239fall2025.svc.cluster.local:9091
              - post-storage-service.cse239fall2025.svc.cluster.local:9091
              - social-graph-service.cse239fall2025.svc.cluster.local:9091
              - text-service.cse239fall2025.svc.cluster.local:9091
              - unique-id-service.cse239fall2025.svc.cluster.local:9091
              - url-shorten-service.cse239fall2025.svc.cluster.local:9091
              - user-service.cse239fall2025.svc.cluster.local:9091
              - user-mention-service.cse239fall2025.svc.cluster.local:9091
        metrics_path: /metrics
        scrape_interval: 15s
        scrape_timeout: 10s
        relabel_configs:
          # Add service name label
          - source_labels: [__address__]
            regex: '([^.]+)\..*'
            target_label: service
            replacement: '${1}'

      # -------------------------------------------------------
      # 3) Pushgateway (Fallback for CPU/Memory metrics from kubectl top)
      # -------------------------------------------------------
      - job_name: 'pushgateway'
        honor_labels: true
        static_configs:
          - targets:
              - pushgateway.cse239fall2025.svc.cluster.local:9091
