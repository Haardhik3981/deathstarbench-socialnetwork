# Vertical Pod Autoscaler (VPA) for User Service - Experiment Configurations
#
# WHAT THIS DOES:
# VPA automatically adjusts CPU/memory per pod. This file contains multiple
# VPA configurations for different experiments to find the optimal resource
# allocation that maintains <500ms latency while minimizing cost.
#
# EXPERIMENT STRATEGY:
# Run different VPA configurations and measure:
# 1. Latency (should stay <500ms)
# 2. Cost per request (CPU/memory usage)
# 3. Pod count (affected by resource allocation)
#
# Then plot: latency vs cost to find optimal configuration

---
# Experiment 1: Conservative Resources (Lower Cost)
# Hypothesis: Minimal resources, rely on HPA to scale horizontally
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-service-vpa-conservative
  namespace: default
  labels:
    experiment: vpa-conservative
    cost-priority: high
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  updateMode: "Off"  # Start with Off to see recommendations, then switch to Initial
  # For experiments, you can use "Initial" to apply recommendations automatically
  
  resourcePolicy:
    containerPolicies:
    - containerName: user-service
      # Conservative limits - lower cost per pod
      minAllowed:
        cpu: 100m      # Minimum 0.1 CPU
        memory: 128Mi  # Minimum 128 MB
      maxAllowed:
        cpu: 500m      # Maximum 0.5 CPU (lower = more pods needed)
        memory: 512Mi  # Maximum 512 MB
      controlledResources: ["cpu", "memory"]
      controlledValues: RequestsAndLimits

---
# Experiment 2: Moderate Resources (Balanced)
# Hypothesis: Balanced resources, moderate cost
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-service-vpa-moderate
  namespace: default
  labels:
    experiment: vpa-moderate
    cost-priority: balanced
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  updateMode: "Off"
  
  resourcePolicy:
    containerPolicies:
    - containerName: user-service
      minAllowed:
        cpu: 200m
        memory: 256Mi
      maxAllowed:
        cpu: 1000m     # 1 CPU (moderate)
        memory: 1Gi    # 1 GB (moderate)
      controlledResources: ["cpu", "memory"]
      controlledValues: RequestsAndLimits

---
# Experiment 3: Aggressive Resources (Higher Cost, Lower Latency)
# Hypothesis: More resources per pod = better latency, fewer pods needed
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-service-vpa-aggressive
  namespace: default
  labels:
    experiment: vpa-aggressive
    cost-priority: low
    latency-priority: high
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  updateMode: "Off"
  
  resourcePolicy:
    containerPolicies:
    - containerName: user-service
      minAllowed:
        cpu: 500m
        memory: 512Mi
      maxAllowed:
        cpu: 2000m    # 2 CPUs (aggressive)
        memory: 2Gi    # 2 GB (aggressive)
      controlledResources: ["cpu", "memory"]
      controlledValues: RequestsAndLimits

---
# Experiment 4: CPU-Optimized (For CPU-bound workloads)
# Hypothesis: More CPU = better performance for compute-intensive operations
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-service-vpa-cpu-optimized
  namespace: default
  labels:
    experiment: vpa-cpu-optimized
    optimization: cpu
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  updateMode: "Off"
  
  resourcePolicy:
    containerPolicies:
    - containerName: user-service
      minAllowed:
        cpu: 500m
        memory: 256Mi
      maxAllowed:
        cpu: 2000m    # High CPU
        memory: 1Gi   # Moderate memory
      controlledResources: ["cpu", "memory"]
      controlledValues: RequestsAndLimits

---
# Experiment 5: Memory-Optimized (For memory-bound workloads)
# Hypothesis: More memory = better performance for data-intensive operations
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-service-vpa-memory-optimized
  namespace: default
  labels:
    experiment: vpa-memory-optimized
    optimization: memory
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  updateMode: "Off"
  
  resourcePolicy:
    containerPolicies:
    - containerName: user-service
      minAllowed:
        cpu: 200m
        memory: 512Mi
      maxAllowed:
        cpu: 1000m    # Moderate CPU
        memory: 2Gi   # High memory
      controlledResources: ["cpu", "memory"]
      controlledValues: RequestsAndLimits

